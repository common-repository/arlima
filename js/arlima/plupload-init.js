/**
 * Upload images using arlima and plupload
 */var ArlimaUploader=function(e,t,i,a,n){return{$notifyElement:!1,$mainUploadElement:!1,_mainDropElementID:"arlima-article-image",removeNotifier:function(){if(this.$notifyElement){this.$notifyElement.remove();var e=this;setTimeout(function(){e.$notifyElement=!1},900)}},init:function(){this.$mainUploadElement=e("#"+this._mainDropElementID);var t=new n.Uploader({runtimes:"html5",container:"arlima-article-image-container",max_file_size:"10mb",url:a.ajaxurl,drop_element:"arlima-article-image",filters:[{title:"Image files",extensions:"jpg,gif,png,jpeg"}],browse_button:"arlima-article-image-browse",multi_selection:!1,multipart:!0,multipart_params:{action:"arlima_upload",postid:null,_ajax_nonce:a.arlimaNonce}}),r=this,l=function(t,i){r.$notifyElement||(r.$notifyElement=e('<div class="file-progress"></div>'),r.$notifyElement.appendTo(r.$mainUploadElement));var a;i?(a=r.$notifyElement.find("#"+i),0==a.length&&(a=e("<p></p>").attr("id",i).appendTo(r.$notifyElement))):(a=e("<p></p>"),a.appendTo(r.$notifyElement)),a.text(t)};t.init(),t.bind("FileUploaded",function(t,a,n){r.removeNotifier();var l=e.parseJSON(n.response),o={html:l.html,size:"full",attach_id:l.attach_id,connected:1};i.ArticleEditor.updateArticleImage(o),i.ArticleEditor.updateArticle();var m=i.ArticleEditor.$item.data("article").post_id;m&&i.Backend.connectAttachmentToPost(m,l.attach_id)}),t.bind("FilesAdded",function(i,a){t.settings.multipart_params.postid=e("#arlima-article-post_id").val(),e.each(a,function(e,t){l(t.name.substring(0,10)+" "+n.formatSize(t.size),"file-"+t.id)}),i.refresh(),i.start()}),t.bind("UploadProgress",function(e,t){l(t.name.substring(0,10)+" "+t.percent+"%","file-"+t.id)}),t.bind("Error",function(e,t){l("Error: "+t.code+", Message: "+t.message+(t.file?", File: "+t.file.name:"")),e.refresh()}),t.bind("FileUploaded",function(e,t){l(t.name.substring(0,10)+" 100%","file-"+t.id)}),this.makeDropable(this.$mainUploadElement)},makeDropable:function(t){if("enabled"!=t.attr("data-dropzone")){var a=this;t.attr("data-dropzone","enabled").bind("dragenter",function(){return a.$mainUploadElement.height(a.$mainUploadElement.height()),a.$mainUploadElement.children().hide(),a.$mainUploadElement.addClass("empty"),a.$mainUploadElement.addClass("dragover"),!1}).bind("dragleave",function(){var e=a.$mainUploadElement.children();e.length>0&&(e.show(),a.$mainUploadElement.removeClass("empty")),a.$mainUploadElement.css("height","auto"),a.$mainUploadElement.removeClass("dragover")}).bind("drop",function(t){a.$mainUploadElement.css("height","auto"),a.$mainUploadElement.removeClass("dragover"),t.preventDefault();var n=t.originalEvent.dataTransfer;try{if(-1!=n.types.indexOf("Files"))return!1}catch(r){}try{if(n.types.contains("application/x-moz-file"))return!1}catch(r){}var l=n.getData("URL");if((!l||-1==l.toLowerCase().indexOf(".jpg")&&-1==l.toLowerCase().indexOf(".png"))&&(l=n.getData("text/x-moz-url")),!l||-1==l.toLowerCase().indexOf(".jpg")&&-1==l.toLowerCase().indexOf(".png")){var o=n.getData("text/html"),m=e(o);l=e(m).is("img")?e(m).attr("src"):e("img",m).length>0?e("img",m).attr("src"):null}return!l||-1==l.toLowerCase().indexOf(".jpg")&&-1==l.toLowerCase().indexOf(".png")?!1:((0===l.indexOf("http://trip/")||0===l.indexOf("http://trip.vk.se/"))&&(l=l.replace("/preview/","/hires/")),i.Backend.plupload(l,e("#arlima-article-post_id").val(),function(e){var t={html:e.html,size:"full",attach_id:e.attach_id};i.ArticleEditor.updateArticleImage(t),i.ArticleEditor.updateArticle()}),t.stopPropagation(),!1)})}}}}(jQuery,window,Arlima,ArlimaJS,plupload);