/**
 * Arlima admin library
 *
 * @todo: Look over all insufficient use of jQuery
 * @todo: move each class to its own file and write unit test
 *
 * Dependencies:
 *  - jQuery
 *  - jQuery.effects
 *  - jQuery.qtip
 *  - jQuery.slider
 *  - ArlimaJS
 *  - ArlimaTemplateLoader
 */var Arlima=function(t,e,i,a){"use strict";function r(e,i,a,r,s){this.jQuery=i,this.id=e,this.isImported=a,this.isUnsaved=!1,this.titleElement=r,this.options=t.isPlainObject(s)?s:{};var n=this;t.each(this.options,function(e,i){t.isNumeric(i)&&(n.options[e]=parseInt(i,10))})}function s(t,e){void 0===e&&(e="log"),"undefined"!=typeof console&&"function"==typeof console[e]&&console[e](t)}function n(e){return e?(e=t.isNumeric(e)?parseInt(e,10):e.publish_date,e&&1e3*e>(new Date).getTime()):!1}function o(t,e){return e||(e=30),t=t?t.toString():"",t.length>e?t.substr(0,e-3)+"...":t}function l(t){return t.ctrlKey||t.metaKey}var d={queryPosts:function(t,e){this._ajax("arlima_query_posts",t,e)},getLaterVersion:function(t,e,i){this._ajax("arlima_check_for_later_version",{alid:t,version:e},i)},getPost:function(t,e){this._ajax("arlima_get_post",{postid:t},e)},getPostAttachments:function(t,e){this._ajax("arlima_get_attached_images",{postid:t},e)},connectAttachmentToPost:function(t,e,i){this._ajax("arlima_connect_attach_to_post",{attachment:e,post:t},i)},saveList:function(t,e,i){this._ajax("arlima_save_list",{alid:t,articles:e},i)},savePreview:function(t,e,i){this._ajax("arlima_save_list",{alid:t,articles:e,preview:1},i)},removeImageVersions:function(t,e){this._ajax("arlima_remove_image_versions",{attachment:t},e)},loadCustomTemplateData:function(t){this._ajax("arlima_print_custom_templates",{},t)},loadListData:function(t,e,i){this._ajax("arlima_add_list_widget",{alid:t,version:e},i)},loadListSetup:function(t){this._ajax("arlima_get_list_setup",{},t)},plupload:function(e,i,a){var r=e.substr(e.lastIndexOf(".")+1).toLowerCase(),n=r.indexOf("?");n>-1&&(r=r.substr(0,n)),-1==t.inArray(r,["jpg","jpeg","png","gif"])?(s("Trying to upload something that's not considered to be an image","error"),"function"==typeof a&&a(!1)):this._ajax("arlima_upload",{imgurl:e,postid:i},a)},saveListSetup:function(t,e){this._ajax("arlima_save_list_setup",{lists:t},e)},loadScissorsHTML:function(t,e){this._ajax("arlima_get_scissors",{attachment_id:t},e,"html")},duplicateImage:function(t,e){this._ajax("arlima_duplicate_image",{attachid:t},e)},_ajax:function(i,a,r,n){a.action=i,a._ajax_nonce=e.arlimaNonce,void 0===n&&(n="json"),t.ajax({url:e.ajaxurl,type:"POST",data:a,dataType:n,success:function(t){-1==t?(alert(e.lang.loggedOut),t=!1):t.error&&(alert(t.error),t=!1),"function"==typeof r&&r(t)},error:function(t,e){if(0==t.status)return s("The request is refused by browser, most probably because of fast reloading of the page before ajax call was completed","warn"),void 0;var i=t.responseText;if("undefined"!=typeof JSON){var a=!1;try{a=JSON.parse(i)}catch(n){}a&&"undefined"!=typeof a.error&&(i=a.error)}alert("ERROR:\n------------\n"+i),s(t,"error"),s(e,"error"),"function"==typeof r&&r(!1)}})}},c={_$blocker:null,_$form:null,_$preview:null,hasPreviewIframe:!1,currentlyEditedList:!1,$item:!1,_$imgContainer:!1,_$sticky:!1,_isSlidingForm:!1,_formSlidingCallback:!1,init:function(){this._$preview=t("#arlima-preview"),this._$form=t("#arlima-edit-article-form"),this._$imgContainer=t("#arlima-article-image"),this._$sticky=t("#sticky-interval"),this._$blocker=t("<div></div>"),this._$blocker.css({height:0,width:0}).appendTo("body").addClass("arlima-editor-blocker"),"undefined"==typeof t.fn.effect&&(s("This wordpress application is outdated. Please update to the newest version","warn"),t.fn.effect=function(){}),void 0!==a.arlimaTemplateStylesheets&&(this.hasPreviewIframe=!0,this._$preview.html('<iframe name="arlima-preview-iframe" id="arlima-preview-iframe" style="width:100%; height: 200px; overflow: hidden" border="0" frameborder="0"></iframe>'),setTimeout(function(){t.each(a.arlimaTemplateStylesheets,function(t,e){c._previewIframe().find("head").append('<link rel="stylesheet" type="text/css" href="'+e+'" />')}),c._previewIframe().addClass("arlima-preview-iframe").css({border:0,padding:0,margin:0,overflow:"hidden"}).find("body").addClass("arlima-preview")},500)),this.PostConnector.init(this._$form)},_previewIframe:function(){return this._$preview.find("iframe").contents()},_getFormHeader:function(){return this._$form.parent().parent().prev().prev()},updateArticle:function(i,a){if(void 0===a&&(a=!0),void 0===i&&(i=!0),i&&this.currentlyEditedList.toggleUnsavedState(!0),"object"==typeof i){var s=i.name;"options-"==s.substr(0,8)?this.$item.data("article").options[s.substr(8)]=i.value:this.$item.data("article")[s]=i.value,this.updateArticleStreamerPreview(),a&&this.isShowingPreview()&&this.updatePreview()}else{var n=this._$form.serializeObject();n.options={},t.each(n,function(t,e){"options-"==t.substr(0,8)&&(n.options[t.substr(8)]=e,delete n[t])}),n.text=t.tinyMCEContent(),n.image_options=t("#arlima-article-image-options").data("image_options");var o=this.$item.data("article");if(t.extend(o,n),this.$item.data("article",o),r.applyItemPresentation(this.$item,o),this.PostConnector.toggleFutureNotice(o.publish_date),o.options&&o.options.sticky&&t(".sticky-interval-fancybox").attr("title",e.lang.sticky+" ("+o.options.sticky_interval+")"),t(".arlima-listitem-title:first",this.$item).html(r.getArticleTitleHTML(o)),this.updateArticleStreamerPreview(),a&&this.isShowingPreview()&&this.updatePreview(),o.options&&o.options.sticky){this._$sticky.show();var l=this._$sticky.find("input");""==t.trim(l.val())&&l.val("*:*")}else this._$sticky.hide()}p.triggerEvent("articleUpdate",this.$item)},articleTemplate:function(t){var e=this.currentlyEditedList.defaultTemplate(),a=t.options?t.options.template:void 0;return a&&(void 0===i.templates[a]?s('Use of unknown custom template "'+a+'"',"warn"):e=a),e},currentArticleTemplate:function(){return this.articleTemplate(this.$item.data("article"))},updatePreview:function(){function e(r,n,o,l,d){if(!i.finishedLoading)return setTimeout(function(){e(r,n,o,l,d)},500),void 0;var p={container:{id:"teaser-"+n.id,"class":"arlima teaser "+(l?l:"")},article:{html_text:n.text,title:n.title},streamer:!1,image:!1,related:!1,is_child:o,is_child_split:d===!0,sub_articles:!1,child_articles:!1,format:!1};if(""!=n.title){var h=n.title.replace("__","<br />");n.options&&n.options.pre_title&&(h='<span class="arlima-pre-title">'+n.options.pre_title+"</span> "+h);var m=c.currentlyEditedList.titleElement||"h2";p.article.html_title="<"+m+' style="font-size:'+n.title_fontsize+'px">'+h+"</"+m+">"}if(n.post_id&&(p.container["class"]+=" post-"+n.post_id),n.options&&(n.options.format&&(p.container["class"]+=" "+n.options.format,p.container.format=n.options.format),n.options.streamer&&(p.streamer={type:n.options.streamer_type,content:"image"==n.options.streamer_type?'<img src="'+n.options.streamer_image+'" />':n.options.streamer_content,style:"background: #"+n.options.streamer_color},"extra"==n.options.streamer_type?(p.streamer.style="",p.streamer.content="EXTRA"):"image"==n.options.streamer_type&&(p.streamer.style=""))),n.image_options&&n.image_options.html){switch(p.image={src:t(unescape(n.image_options.html)).attr("src"),image_class:n.image_options.alignment,image_size:n.image_options.size,width:"auto"},n.image_options.size){case"half":p.image.width="50%";break;case"third":p.image.width="33%";break;case"quarter":p.image.width="25%";break;case"fifth":p.image.width="20%";break;case"sixth":p.image.width="15%"}p.container["class"]+=" img-"+n.image_options.size}if(n.children){var u=n.children.length;if(u>0){{var f=t("<div />"),v=!1,g="";n.children.length%2===0}f.addClass("teaser-children children-"+u).appendTo(r),t.each(n.children,function(i,r){var s=t("<div />"),n=a.$topItem.find(".listitem").eq(i).data("extraClasses");n.indexOf(" first")>-1&&(g+='<div class="arlima child-wrapper">',v=!0),e(s,r,!0,n,u>1),g+=s.html(),v&&n.indexOf(" last")>-1&&(g+="</div>",v=!1)}),v&&(g+="</div>",v=!1),f.append(g),p.child_articles=f.html(),p.sub_articles=p.child_articles}}var _=c.articleTemplate(n),y=i.templates[_];"undefined"==typeof y&&(y=i.templates.article,s('Trying to use template "'+_+'" but it does not exist, now using article.tmpl instead',"warn")),y=y.replace(/href="([a-zA-Z\.\{+\}\$]+)"/g,'href="Javascript:void(0)"'),y=y.replace(/{{html image.src}}/g,p.image.src?p.image.src:""),r.empty().append(t("<div>"+y+"</div>").tmpl(p))}var a=this,r=this.serializeArticle(this.$item,!0);this.$topItem=this.$item,parseInt(r.parent,10)>-1&&(this.$topItem=this.$item.parent().parent(),r=this.serializeArticle(this.$topItem,!0));var n=this._$preview;if(this.hasPreviewIframe&&(n=this._previewIframe().find("body")),e(n,r,!1),this.hasPreviewIframe){var a=this,o=function(){var t=n.children().eq(0).outerHeight();t||(t=400),a._$preview.find("iframe").eq(0).height(t)};setTimeout(o,50),n.find("img").bind("load",o)}var l=t(".article-preview-width",p.getFocusedList().jQuery).val();l&&c._$preview.children().eq(0).css("width",l+"px"),p.triggerEvent("previewUpdate",this.$item)},serializeArticle:function(e,i){void 0===i&&(i=!1);var a=e.data("article");if("undefined"==typeof a)return{};if(a.title_fontsize||(a.title_fontsize=24),a.children=[],i&&(a.text=a.text.replace(new RegExp('(<span)(.*class=".*teaser-entryword.*")>(.*)(</span>)',"g"),'<span class="teaser-entryword">$3</span>')),e.has("ul")){var r=this;t("ul li",e).each(function(){a.children.push(r.serializeArticle(t(this),i))})}return a},edit:function(i,a){p.setFocusedList(a);var r=this,s=this.isShowingPreview();this.clear(),this.currentlyEditedList=a,this.$item=i;var n=a.jQuery.parent();n.find(".edited").removeClass("edited"),n.find(".active").removeClass("active"),a.jQuery.addClass("active"),i.addClass("edited");var o=this._$form.parent();o.is(":visible")||(this._isSlidingForm=!0,o.slideDown("100",function(){r._isSlidingForm=!1,"function"==typeof r._formSlidingCallback&&(r._formSlidingCallback(),r._formSlidingCallback=null)}));var l=this.$item.data("article");if(l.title_fontsize||(l.title_fontsize=24),this.PostConnector.setup(l),t.tinyMCEContent(l.text),t("#arlima-edit-article-title-fontsize-slider").slider("value",l.title_fontsize),t.each(l,function(e,i){t("[name='"+e+"']",r._$form).not(":radio").val(i)}),!e.is_admin){var d=t("[name='options-admin_lock']",this._$form);d.on("click",function(t){return t.preventDefault(),!1}),d.parent().addClass("not_allowed").attr("title",e.lang.admin_only),d.parent().find("label").on("click",function(t){return t.preventDefault(),!1})}var h=this.currentlyEditedList.defaultTemplate(),m=t("#arlima-edit-article-options-template");m.find("option").removeAttr("disabled").each(function(){return this.value==h?(t(this).attr("disabled","disabled"),!1):!0}),t.each(p.getFocusedList().options.hidden_templates||[],function(t,e){m.find('option[value="'+e+'"]').attr("disabled","disabled")});var u=this.articleTemplate(l);this.toggleAvailableFormats(u),this.toggleEditorFeatures(u);var f=t("[name='options-hiderelated']",this._$form);l.options?(t.each(l.options,function(e,i){t("[name='options-"+e+"']",r._$form).val(i)}),l.options.streamer&&t("[name='options-streamer']",this._$form).prop("checked",!0).parent().addClass("checked"),l.options.sticky&&t("[name='options-sticky']",this._$form).prop("checked",!0).parent().addClass("checked"),l.options.admin_lock&&t("[name='options-admin_lock']",this._$form).prop("checked",!0).parent().addClass("checked"),l.options.streamer_color?t("#arlima-edit-article-options-streamer-text div",this._$form).css("background","#"+l.options.streamer_color):t("#arlima-edit-article-options-streamer-text div",this._$form).css("background","#000"),f.prop("checked",!1),f.length>0&&l.options.hiderelated&&f.prop("checked",!0)):f.length>0&&"checked"==f.attr("data-default")&&f.prop("checked",!0),this.updateArticleImage(l.image_options,!1),this.updateArticle(!1),this.currentlyEditedList.isImported?(this.toggleEditorBlocker(!0),l.image_options.url&&c._$imgContainer.find("img").one("load",function(){setTimeout(function(){r.toggleEditorBlocker(!0)},100)})):(this.toggleEditorBlocker(!1),this.updateArticleStreamerPreview(),!e.is_admin&&l.options&&l.options.admin_lock&&this.toggleEditorBlocker(!0,e.lang.admin_lock),s&&this.togglePreview(!0))},toggleAvailableFormats:function(e){""==e&&(e=this.currentlyEditedList.defaultTemplate());var i=t("#arlima-edit-article-options-format option");i.removeAttr("disabled"),i.each(function(){var a=t(this),r=a.attr("data-arlima-template");""!=a.val()&&r&&-1==r.indexOf("["+e+"]")&&(a.attr("disabled","disabled"),a.is(":selected")&&(i.get(0).selected=!0))})},updateArticleStreamerPreview:function(){var i=t("#arlima-edit-article-options-streamer-type").val();t("#arlima-edit-article-options-streamer").is(":checked")?(""!=t("[name='options-streamer_image']").val()?t("#arlima-edit-article-options-streamer-image-link").html('<img src="'+t("[name='options-streamer_image']").val()+'" width="170" style="vertical-align:middle;" />'):t("#arlima-edit-article-options-streamer-image-link").html(e.lang.chooseImage),t("#arlima-edit-article-options-streamer-content").show(),t(".arlima-edit-article-options-streamer-choice").not("#arlima-edit-article-options-streamer-"+i).hide(),0==i.indexOf("text-")?t("#arlima-edit-article-options-streamer-text").show().find("div:last").hide():(t("#arlima-edit-article-options-streamer-"+i).show(),t("#arlima-edit-article-options-streamer-text").find("div:last").show())):t("#arlima-edit-article-options-streamer-content").hide()},toggleEditorFeatures:function(e){var a=this.data("options").section_divider?!0:!1,r=this.data("options").file_include;t(".arlima-streamer").show(),a||r?(t("#arlima-article-wp-connection").hide(),t("#wp-tinyMCE-wrap").hide(),t("#arlima-article-image-container").hide(),t("#arlima-article-settings").hide(),t("#arlima-edit-article-title-fontsize").hide(),t("#arlima-edit-article-title-fontsize-slider").hide(),t("#file-include-info").hide()):(t("#arlima-article-wp-connection").show(),t("#arlima-article-image-container").show(),t("#arlima-article-settings").show(),t("#arlima-edit-article-title-fontsize").show(),t("#arlima-edit-article-title-fontsize-slider").show()),""==e&&(e=this.currentlyEditedList.defaultTemplate());var s=i.templates[e],n=t("#file-include-info");if(r){n.show(),n.find(".file").text(r.split("/wp-content")[1]||r),n.find(".args").remove();var o=r.replace(/\./g,"-").replace(/\\/g,"-").replace(/\//g,"-"),l=t("#arlima-article-file-includes ."+o).attr("data-args");if(l){var d="";t.each(JSON.parse(l),function(t,e){d+="<strong>"+t+"</strong> = "+e+"<br />"}),n.append('<p class="args"><span style="color:#999">'+d+"</span></p>")}}else if(void 0!==s&&!a){n.hide();var c=t(".arlima-streamer");if(s.indexOf("${streamer.")>-1)c.show();else{var h=c.find("input");h.eq(0).is(":checked")&&h[0].click(),c.hide()}s.indexOf("article.html_text")>-1?t("#wp-tinyMCE-wrap").show():t("#wp-tinyMCE-wrap").hide(),s.indexOf("${article.url}")>-1||s.indexOf("{html article.html_title}")>-1?t("#arlima-article-wp-connection").show():t("#arlima-article-wp-connection").hide(),s.indexOf("{html article.html_title}")>-1?(t("#arlima-edit-article-title-fontsize-slider").show(),t("#arlima-edit-article-title-fontsize").show()):(t("#arlima-edit-article-title-fontsize-slider").hide(),t("#arlima-edit-article-title-fontsize").hide()),p.getFocusedList().getOption("allows_template_switching")?t("#template-switcher").show():t("#template-switcher").hide();var m=i.templateSupport(e,"image-support"),u=t("#arlima-article-image-size option");if(u.removeAttr("disabled"),m){var f=this.isEditingChildArticle()&&this.$item.data("extraClasses").indexOf("teaser-split")>-1;f&&m["children-size"]&&"*"!=m["children-size"]?(u.attr("disabled","disabled"),t.each(m["children-size"].split(","),function(e,i){u.filter('[value="'+t.trim(i)+'"]').removeAttr("disabled")})):!f&&m.size&&"*"!=m.size&&(u.attr("disabled","disabled"),t.each(m.size.split(","),function(e,i){var a=u.filter('[value="'+t.trim(i)+'"]');0==a.length?u.parent().append('<option value="'+i+'">'+i+"</option>"):a.removeAttr("disabled")}))}}},isEditingChildArticle:function(){return this.isEditingArticle()&&-1!=(this.data("parent")||-1)},removeImageVersions:function(){var e=parseInt(t("#arlima-article-image-attach_id").val(),10);!isNaN(e)&&e&&d.removeImageVersions(e)},updateArticleImage:function(e,a){var r=t("#arlima-article-image-size"),s=t("#arlima-article-image-alignment input"),n=t("#arlima-article-image-attach_id"),o=t("#arlima-article-image-updated"),l=t("#arlima-article-image-connected_to_post_thumbnail"),d=r.val(),c=i.templateSupport(this.currentArticleTemplate(),"image-support");if(e&&(e.html&&this._$imgContainer.html(unescape(e.html)).removeClass("empty"),e.alignment&&s.filter("[value="+e.alignment+"]").prop("checked",!0),e.size&&(r.val(e.size),d=e.size),e.attach_id&&n.val(e.attach_id),e.updated&&o.val(e.updated),void 0!==e.connected&&l.val(e.connected)),c){var p=this.isEditingChildArticle()&&this.$item.data("extraClasses").indexOf("teaser-split")>-1?"children-size":"size";"string"==typeof c[p]&&"*"!=c[p]&&-1==c[p].indexOf(d)&&(d=t.trim(c[p].split(",")[0]),r.find("option").removeAttr("selected"),r.find('option[value="'+d+'"]').attr("selected","selected"))}if("full"==d)s.filter("[value=aligncenter]").prop("checked",!0),s.parent().hide();else{s.parent().show();var h=s.filter(":checked").val()||!1;h&&"aligncenter"!=h||s.filter("[value=alignleft]").prop("checked",!0)}var m=t("#arlima-article-image-disconnect");1==l.val()||"true"==l.val()?m.show():m.hide();var u=this._$imgContainer.find("img"),f={};u.length>0&&(u.removeAttr("width"),u.removeAttr("height"),f=this.createArlimaArticleImageObject(t(u).parent().html(),s.filter(":checked").val(),r.val(),n.val(),o.val(),l.val()));var v=t("#arlima-article-image-options");v.data("image_options",f),f.html?(v.show(),t("#arlima-article-image-links .hide-if-no-image").show(),f.attach_id||t("#arlima-article-image-scissors-popup").parent("li").hide()):(v.hide(),t("#arlima-article-image").addClass("empty"),t("#arlima-article-image-links .hide-if-no-image").hide()),("undefined"==typeof a||a===!0)&&this.updateArticle()},createArlimaArticleImageObject:function(e,i,a,r,s,n){var o=t(e);return{html:escape(e),url:o.attr("src"),alignment:i,size:a,attach_id:r,updated:s,connected:n}},removeArticleImage:function(e){t("#arlima-article-image").html("").addClass("empty"),t("#arlima-article-image-options").data("image_options",{}).hide().find(".hide-if-no-image").hide(),("undefined"==typeof e||e===!0)&&this.updateArticle()},isEditingList:function(e){return t.isNumeric(e)||(e=e.id),this.currentlyEditedList&&this.currentlyEditedList.id==e},togglePreview:function(t){this.currentlyEditedList&&!this.currentlyEditedList.isImported&&(void 0===t&&(t=!this.isShowingPreview()),t?(this.updatePreview(),this._$preview.show()):this._$preview.hide())},isShowingPreview:function(){return this._$preview.is(":visible")},previewElement:function(){return this.hasPreviewIframe?this._previewIframe():this._$preview},toggleEditorBlocker:function(e,i){if("undefined"==typeof e&&(e=!this._$blocker.is(":visible")),e){var a=this,r=a._$form.parent().parent(),s=this._getFormHeader(),n=function(){var e=s.offset(),n=s.outerWidth();if(a._$blocker.css({height:r.outerHeight()+s.outerHeight()+"px",width:n+"px",top:e.top+"px",left:e.left+"px"}),a._$blocker.show(),i){var o=a._$blocker.find(".block-msg");0==o.length&&(o=t("<div></div>"),o.addClass("block-msg").appendTo(a._$blocker)),o.text(i)}};this._isSlidingForm?a._formSlidingCallback=n:n()}else this._$blocker.hide(),this._$blocker.find(".block-msg").remove()},hideForm:function(){this._$form.parent().parent().find(".handlediv").trigger("click")},clear:function(){this.currentlyEditedList&&this.togglePreview(!1),this.$item=!1,this.currentlyEditedList=!1,this.toggleEditorBlocker(!1),t.tinyMCEContent(""),t(":input",this._$form).not(":button, :submit, :radio, :checkbox").val(""),t(":input",this._$form).prop("checked",!1).prop("selected",!1),t(".arlima-button").removeClass("checked"),t("#arlima-article-image").html(""),t("#arlima-article-image-options").removeData("image_options").hide(),t("#arlima-article-connected-post-change").show(),t("#arlima-article-post_id").hide(),t("#arlima-edit-article-options-streamer-content").hide()},isEditingArticle:function(){return this.$item!==!1},data:function(t){return this.isEditingArticle()?this.$item.data("article")[t]:(s("Trying to get article data but no article is being edited","warn"),!1)}};c.PostConnector={_$openButton:!1,_$urlInput:!1,_$postIdInput:!1,_$targetInput:!1,_$info:!1,_$tinyMCEMediaButton:!1,_$futureNotice:!1,currentPost:!1,posts:[],$fancyBox:!1,init:function(e){this._$info=t("#arlima-article-connected-post",e),this._$tinyMCEMediaButton=t("#tinyMCE-add_media",e),this._$openButton=t("#arlima-article-connected-post-open",e),this._$urlInput=e.find('input[name="options-overriding_url"]'),this._$targetInput=e.find('input[name="options-target"]'),this._$postIdInput=e.find('input[name="post_id"]'),this._$futureNotice=t("#future-notice",e),this.$fancyBox=t("#post-connect-fancybox")},setup:function(e){var i=this;0==e.post_id&&(e.post_id=null);var r=[];e.post_id&&r.push(e.post_id);var s=e.children;if(e.parent&&-1!=e.parent){var n=c.$item.parent().parent().data("article");n.post_id&&-1==t.inArray(n.post_id,r)&&r.push(n.post_id),s=n.children}if(s&&s.length&&t.each(s,function(e,i){i.post_id&&-1==t.inArray(i.post_id,r)&&r.push(i.post_id)}),e.post_id)this._$info.html(""),this._$tinyMCEMediaButton.attr("href","media-upload.php?post_id="+e.post_id+"&type=image&TB_iframe=1&send=true");else{this._$tinyMCEMediaButton.attr("href","media-upload.php?type=image&TB_iframe=1&send=true");var o=e.options.overriding_url||"";this._setConnectionLabel(o,o)}r.length>0?d.getPost(r.join(","),function(t){if(t.posts||(t={posts:[t]}),!t.posts.length||!t.posts[0].url)throw new Error("Backend did not return a list of posts");p.triggerEvent("postLoaded",t.posts),i.posts=t.posts,i.currentPost=t.posts[0],i._setConnectionLabel("(post #"+i.currentPost.ID+") "+i.currentPost.post_title,i.currentPost.post_title)}):(i.currentPost=!1,i.posts=!1),this._toggleOpenLink(e),this._$openButton.unbind("click"),this._$openButton.bind("click",function(){if(e.post_id)a.open("post.php?post="+e.post_id+"&action=edit");else{var t=e.options.overriding_url||!1;t&&a.open(t)}return!1})},_toggleOpenLink:function(e){e.post_id||e.options.overriding_url?t("#arlima-article-connected-post-open").show():t("#arlima-article-connected-post-open").hide()},toggleFutureNotice:function(t){t&&n(t)?this._$futureNotice.show():this._$futureNotice.hide()},getConnectionLabel:function(){return this._$info.find("em").attr("title")},_setConnectionLabel:function(t,e){this._$info.html('<em style="color:#666" class="tooltip" title="'+t+'">'+o(e)+"</em>")},connect:function(e,i){var a=c.$item.data("article");if(t.isNumeric(e)){if(a.post_id!=e){this._$urlInput.val(""),this._$targetInput.val(""),this._$postIdInput.val(e);var r=this;d.getPost(e,function(e){e&&e.url?(r.currentPost=e,p.triggerEvent("postLoaded",e),t("#arlima-edit-article-url").val(e.url),a.publish_date=e.publish_date,r._setConnectionLabel("(post #"+e.ID+") "+e.post_title,e.post_title)):(r.currentPost=!1,a.publish_date=3,alert("This post has been removed")),c.updateArticle(!0,!1)})}}else(a.url!=e||a.options.target!=i)&&(this._setConnectionLabel(e,e),this._$targetInput.val(i),this._$postIdInput.val(""),this._$urlInput.val(e),a.publish_date=3,c.updateArticle(!0,!1));this._toggleOpenLink(a)}};var p={_focusedList:!1,_lists:{},_$element:null,previewWindow:!1,_events:{},init:function(e){this._$element=t(e)},addEventListener:function(t,e,i){this.removeEventListener(t,e),void 0===this._events[t]&&(this._events[t]=[]),i?this._events[t].unshift(e):this._events[t].push(e)},removeEventListener:function(t,e){if(void 0!==this._events[t])for(var i=0;i<this._events[t].length;i++)if(this._events[t][i]==e)return this._events[t].splice(i,1),!0;return!1},triggerEvent:function(e,i,a){var r=this._events[e];if(t.isArray(r))for(var s=0;s<r.length;s++)r[s](i,a)},loadCustomTemplates:function(){d.loadCustomTemplateData(function(e){if(e){var i=t("#arlima-templates");i.html(e.html),t(".dragger",i).each(function(i,a){r.prepareArticleForListTransactions(t(a),e.articles[i])}).draggable({helper:"clone",sender:"postlist",handle:".handle",connectToSortable:".arlima-list",revert:"invalid"})}})},setupFileIncludes:function(){t("#arlima-article-file-includes .dragger").each(function(){var e=t(this);r.prepareArticleForListTransactions(e,{title:e.attr("data-label"),text:"",url:"",title_fontsize:20,options:{file_include:e.attr("data-file")}}),e.draggable({helper:"clone",sender:"postlist",handle:".handle",connectToSortable:".arlima-list",revert:"invalid"})})},iterateLists:function(t){for(var e in this._lists)this._lists.hasOwnProperty(e)&&t(this._lists[e])},getFocusedList:function(){return this._focusedList},addList:function(t,e,i){if(this.hasList(t))this._lists[t].jQuery.effect("shake",{times:4,distance:10},500);else{var a=this;d.loadListData(t,"",function(s){if(s&&s.exists){var n=r.create(t,s,a._$element,e);a._lists[t]=n,n.jQuery.find(".arlima-list").hide().slideDown("fast",function(){n.jQuery.trigger("init-list-container")})}"function"==typeof i&&i()})}},getUnsavedLists:function(){var t=[];return this.iterateLists(function(e){e.isUnsaved&&t.push(e)}),t},reloadList:function(i,a){c.isEditingList(i)&&(c.clear(),c.hideForm()),i.toggleUnsavedState(!1),i.toggleAjaxLoader(!0),i.jQuery.find(".arlima-list").fadeOut("fast",function(){d.loadListData(i.id,a,function(a){i.toggleAjaxLoader(!1),a&&(a.exists?(i.jQuery.find(".arlima-list").html(""),i.fill(a.articles,!1,!0),i.displayVersionInfo(a.version,a.versioninfo,a.versions),i.jQuery.find(".arlima-list").fadeIn("fast"),i.isImported||(t("html").trigger("click"),i.toggleUnsavedState(a.versions[0]!=a.version.id))):(alert(e.lang.listRemoved),p.removeList(i.id)),p.triggerEvent("listLoaded",i))})})},hasList:function(t){return"undefined"!=typeof this._lists[t]},removeList:function(t){var e="object"==typeof t?t.id:t.toString();if(this.hasList(e)){c.isEditingList(e)&&(c.clear(),c.hideForm());var i=this;this._lists[e].jQuery.slideUp("fast",function(){this._focusedList&&this._focusedList.id==e&&(c.clear(),this._focusedList=!1),delete i._lists[e]})}else s("Trying to remove list that does not exist "+e,"warn")},loadSetup:function(e){t("#setup-loader").show();var i=function(){t("#setup-loader").hide(),"function"==typeof e&&e()};d.loadListSetup(function(e){if(e){var a=e.length;0==a?i():t.each(e,function(t,e){var r={top:parseInt(e.top),left:parseInt(e.left),height:parseInt(e.height),width:parseInt(e.width)};p.addList(e.alid,r,function(){a--,0==a&&i()})})}else i()})},saveSetup:function(){var e=t("#save-setup-loader");e.show();var i=[];this.iterateLists(function(t){var e=t.jQuery.position();i.push({alid:t.id,top:e.top,left:e.left,width:t.jQuery.width(),height:t.jQuery.height()})}),d.saveListSetup(i,function(){e.hide()})},saveFocusedList:function(){if(this._focusedList){if(this.getFocusedList().isUnsaved){var i=this.getFocusedList();i.toggleAjaxLoader(!0);var a=t(".arlima-version-id",i.jQuery).val();d.getLaterVersion(i.id,a,function(a){if(a){var r=!0;if(a.version&&(r=confirm(e.lang.laterVersion+" \r\n "+a.versioninfo+"\r\n"+e.lang.overWrite)),t(".streamer-extra",i.jQuery).length>1&&(r=confirm(e.lang.severalExtras+"\r\n"+e.lang.overWrite)),r){var s=[];i.jQuery.find(".arlima-list").children().each(function(e,i){s.push(c.serializeArticle(t(i)))}),d.saveList(i.id,s,function(t){i.toggleUnsavedState(!1),i.toggleAjaxLoader(!1),i.displayVersionInfo(t.version,t.versioninfo,t.versions)})}else i.toggleAjaxLoader(!1)}})}}else alert(e.lang.noList)},searchWordpressPosts:function(e){t("#arlima-get-posts-loader").show();var i={offset:e};return t("#arlima-post-search input, #arlima-post-search select").each(function(){this.name&&(this.type?"checkbox"==this.type&&t(this).is(":checked")?i[this.name]=this.value:"checkbox"!=this.type&&(i[this.name]=this.value):i[this.name]=t(this).val())}),d.queryPosts(i,function(e){if(t("#arlima-get-posts-loader").hide(),e){var i=t("#arlima-posts");i.html(e.html),t(".dragger",i).each(function(i,s){var n=t(s),o=e.posts[i],l=o.content;delete o.content,r.prepareArticleForListTransactions(n,o);var d={position:{my:"right top",at:"center left",viewport:t(a)},style:{classes:"ui-tooltip-shadow ui-tooltip-light ui-tooltip-480"}};d.content='<h2 style="margin:0;">'+o.title+"</h2>"+l,t("a",n.parents("tr")).qtip(d)}),t(".dragger",i).draggable({helper:"clone",sender:"postlist",handle:".handle",connectToSortable:".arlima-list",revert:"invalid"})}}),!1},getList:function(e){var i;return i=t.isNumeric(e)?this._lists[e.toString()]:this._lists[e.closest(".arlima-list-container").attr("data-list-id")],void 0==i?!1:i},setFocusedList:function(e){var i=t.isNumeric(e)?e:e.id.toString();this._focusedList=this._lists[i]},previewFocusedList:function(){this._focusedList?this.previewList(this._focusedList):alert(e.lang.noList)},previewList:function(i){var r=t(".arlima-list-previewpage",i.jQuery).val();if(r)if(i.isUnsaved){var s=null;c.isEditingArticle()&&c.$item.data().article.post_id&&(s=c.$item.data().article.post_id),i.toggleAjaxLoader(!0);var n=this;n.previewWindow&&n.previewWindow.close(),n.previewWindow=a.open(null,"arlimaPreviewWindow","toolbar=1,scrollbars=1,width=10,height=10");var o=function(){if(i.toggleAjaxLoader(!1),n.previewWindow){var o="/"==r||r==e.baseurl+"/"?e.baseurl+"/":r,l=r.indexOf("?")>-1?"&":"?";o+="/"==r?l+e.preview_query_arg:l+e.preview_query_arg,o+="="+i.id,n.previewWindow.document.location=o;var d=t(a);n.previewWindow.resizeTo(d.width(),d.height());var c=0,p=setInterval(function(){c++,c>4||!n.previewWindow?clearInterval(p):n.previewWindow.document&&n.previewWindow.jQuery&&(clearInterval(p),n.previewWindow.jQuery(n.previewWindow.document).ready(function(){n._addPreviewWindowListeners(n.previewWindow.jQuery(n.previewWindow.document),i,s)}))},500);n.previewWindow.focus()}else alert("Your browser has blocked preview popup")};if(i.isUnsaved){var l={};t(">li",i.jQuery.find(".arlima-list")).each(function(e,i){l[e]=c.serializeArticle(t(i))}),d.savePreview(i.id,l,function(t){t&&o()})}else o()}else a.open(r);else alert(e.lang.missingPreviewPage)},_addPreviewWindowListeners:function(i,r,s){i.ready(function(){var a=t("<div></div>");a.css({position:"fixed",top:"30px",left:"0",width:"100%",zIndex:"9999"}).appendTo(i.find("body"));var n=-1==navigator.userAgent.indexOf("Mac")?"ctrl":"cmd";if(t("<div></div>").text(n+" + s "+e.lang.savePreview+' "'+r.getDisplayName()+'"').css({background:"#222",backgroundColor:"rgba(0,0,0, .85)",fontSize:"13px",color:"#FFF",margin:"16px",padding:"10px",webkitborderRadius:"12px",mozBorderRadius:"13px",borderRadius:"12px",fontWeight:"bold",webkitBoxShadow:"0 0 7px #333",mozBoxShadow:"0 0 7px #333",boxShadow:"0 0 7px #333"}).appendTo(a),i.find("#wpadminbar").remove(),i.find("body").css("margin-top","-28px"),s){var o=i.find("[data-post='"+s+"']").first();o.length>0&&i.scrollTop(o.position().top-80)}});var n=this;i.keydown(function(t){var e=t.keyCode?t.keyCode:t.which;return 83==e&&l(t)?(n.saveFocusedList(),n.previewWindow.close(),a.focus(),t.preventDefault(),!1):void 0})},dump:function(){var t=0;this.iterateLists(function(){t++});var e="# Having "+t+" lists on page\n",i=this.getUnsavedLists();if(0==i.length)e+="# Having 0 unsaved lists\n";else{e+="# Having "+i.length+" unsaved lists:\n";for(var a=0;a<i.length;a++){var r=i[a];e+="   - "+r.getDisplayName()+"\n"}}this.getFocusedList()?(e+='# Has focus on list "'+this.getFocusedList().getDisplayName()+'", the list has '+(this.getFocusedList().isUnsaved?"changes":"no changes")+"\n",c.isEditingArticle()&&(e+='# Article "'+c.$item.find(".arlima-listitem-title").text()+'" is being edited')):e+="# Has no focused list\n# Has no article in the editor",s(e,"log");try{s(c.$item.data("article"),"log")}catch(n){}}};r.prototype.toggleAjaxLoader=function(e){var i=t(".ajax-loader",this.jQuery);e?i.show():i.hide()},r.prototype.getOption=function(t){return this.options[t]},r.prototype.defaultTemplate=function(){return t(".arlima-list-previewtemplate",this.jQuery).val()},r.prototype.addSectionDivider=function(){var t={title:"Section divider",text:"",url:"",options:{section_divider:"1"}};
this.fill([t],!1,!0),this.toggleUnsavedState(!0)},r.prototype.rePositionStickyArticles=function(){var e="insertBefore",i=this;this.jQuery.find(".sticky").each(function(){var a=t(this),r=a.prevAll().length,s=a.data("article").options.sticky_pos;if("undefined"!=typeof a.data("article").indexFromLastSectionDivider){for(var n=a.prev();n.length&&!n.hasClass("section-divider");)n=n.prev();n.length&&a.insertBefore(a.siblings().eq(n.index()+a.data("article").indexFromLastSectionDivider))}else if(s!=r){var o=i.jQuery.find(".listitem:not(ul ul > *)");a[e](s>o.length?o.eq(o.length-1):o.eq(s)),a.prevAll().length!=s&&(s++,a[e](s>o.length?o.eq(o.length-1):o.eq(s)))}})},r.prototype.addIndexFromLastSectionDivider=function(t){if(this.options.supports_sections){for(var e=!1,i=t.index(),a=i,r=t.parent().children();a>=0;)if(a--,r.eq(a).hasClass("section-divider")){e=i-a;break}e!==!1&&(t.data("article").indexFromLastSectionDivider=e)}},r.prototype.fill=function(i,a,s){void 0===s&&(s=!0);var n=this,o=a?a:this.jQuery.find(".arlima-list");t.each(i,function(i,a){var s=t("<li />");if(s.addClass("listitem").html('<div><span class="arlima-listitem-title"></span><img class="arlima-listitem-remove" alt="remove" src="'+e.imageurl+'close-icon.png" /></div>'),r.bindArticleItemEvents(s),r.prepareArticleForListTransactions(s,a),a.children&&a.children.length>0){var l=t("<ul />");s.append(l),n.fill(a.children,l,!1),n.setupChildClasses(s)}o.append(s)}),s&&this.applyListBehavior()},r.prototype.setupChildClasses=function(e){var i=e.find("ul li"),a=i.length,r=a%2===0;i.each(function(e){var i="";(4==a&&(1==e||2==e)||6==a&&0!=e&&3!=e||a>1&&4!=a&&6!=a&&(0!=e||r))&&(i+=" teaser-split"+(1==e&&a>2||0==e&&2==a||3==e||4==e&&6==a?" first":" last")),t(this).data("extraClasses",i)})},r.bindArticleItemEvents=function(e){e.find(".arlima-listitem-remove").click(function(e){var i=t(this).parent().parent();return p.getList(i).removeListItem(i,l(e)),e.stopPropagation(),!1}),e.find("div").click(function(e){var i=t(this).parent(),a=p.getList(i);return c.edit(i,a),e.stopPropagation(),!1})},r.prototype.getDisplayName=function(){return t.trim(this.jQuery.find(".arlima-list-header").text())},r.prototype.removeListItem=function(i,a){var r=i.data("article");if(r.options&&r.options.admin_lock&&!e.is_admin)return alert(e.lang.admin_lock),void 0;if(a||confirm(e.lang.wantToRemove+t("span",i).text()+e.lang.fromList)){this.toggleUnsavedState(!0),p.setFocusedList(this.id);var s=this,n=i.hasClass("section-divider");i.fadeOut("fast",function(){var e=i.hasClass("edited");t(this).remove(),s.rePositionStickyArticles(),n&&s.setupStickyIndexes(),i.parent().parent().hasClass("listitem")&&p.getFocusedList().setupChildClasses(i.parent().parent()),c.isEditingList(p.getFocusedList().id)&&(e?(c.clear(),c.hideForm()):c.updatePreview())})}},r.prototype.displayVersionInfo=function(e,i,r){if(this.isImported)this.jQuery.find(".arlima-list-version-info").text(i);else{var s=this.jQuery.find(".arlima-list-version-info");s.html("v "+e.id).attr("title",i).qtip({position:{my:"right top",at:"center left",viewport:jQuery(a)},style:h});var n=this.jQuery.find(".arlima-list-version-ddl");n.html(""),t.each(r,function(i,a){var r=t("<option></option>",{value:a,selected:a==e.id}).text("v "+a+" ");n.append(r)}),this.jQuery.find(".arlima-version-id").val(e.id)}},r.prototype.toggleUnsavedState=function(t){t=t===!0,t!=this.isUnsaved&&(this.isUnsaved=t,this.isUnsaved?(this.jQuery.addClass("unsaved"),this.jQuery.find(".arlima-save-list").show()):(this.jQuery.removeClass("unsaved"),this.jQuery.find(".arlima-save-list").hide()))},r.prepareArticleForListTransactions=function(e,i){e.hasClass("dragger")||t(".arlima-listitem-title",e).html(r.getArticleTitleHTML(i)),e.data("article",i),r.applyItemPresentation(e,i)},r.applyItemPresentation=function(t,i){if(i.options=i.options||{},i.options.section_divider)return t.addClass("section-divider"),!1;if(i.publish_date)if(n(i.publish_date)){var a=new Date(1e3*i.publish_date).getTime();t.addClass("future"),t.attr("title",new Date(a))}else t.removeAttr("title"),t.removeClass("future");else t.removeAttr("title"),t.removeClass("future");if(i.options&&i.options.sticky){t.addClass("sticky");var r=t.attr("title");void 0===r&&(r=""),t.attr("title",r+" "+e.lang.sticky+" ("+i.options.sticky_interval+")")}else t.removeClass("sticky"),t.hasClass("future")||t.removeAttr("title");return!1},r.getArticleTitleHTML=function(t){var e="",i=t.options||{};if(t.title?e=t.title.replace(/__/g,""):t.text&&(e+="["+t.text.replace(/(<.*?>)/gi,"").replace(/__/g,"").substring(0,30)+"...]"),i.pre_title&&(e=i.pre_title+" "+e),i.streamer){var a;switch(i.streamer_type){case"extra":a="black";break;case"image":a="blue";break;default:a="#"+t.options.streamer_color}"#"==a&&(a="black"),e='<span class="arlima-streamer-indicator" style="background:'+a+'"></span> '+e}return i.section_divider&&(e="&ndash;&ndash;&ndash; "+e+"  "),i.sticky&&(e='<span class="sticky-icon">'+e+"</span>"),e},r.create=function(i,a,s,n){var o=t("<div></div>");if(o.addClass("arlima-list-container"+(a.is_imported?" imported":"")).attr("id","arlima-list-container-"+i).attr("data-list-id",i).html(a.html).appendTo(s),!n){n={};var d=s.find("div:last");if(d.length>0){var c=d.position(),h=0,m=0;c.left+d.width()+300<=o.width()&&(m=c.left+d.width(),h=c.top),n={top:h+"px",left:m+"px"}}}o.css(n),o.bind("init-list-container",function(){var i=p._lists[t(this).attr("data-list-id")];i.jQuery.resizable({containment:"parent"}),i.jQuery.draggable({containment:"parent",snap:!0,handle:".arlima-list-header"}),i.applyListBehavior(),i.jQuery.disableSelection(),t(".arlima-refresh-list",this).click(function(t){var a=!0;return!l(t)&&i.isUnsaved&&(a=confirm(e.lang.hasUnsavedChanges)),a&&p.reloadList(i),!1}),t(".arlima-list-container-remove",this).click(function(t){var a=!0;return!l(t)&&i.isUnsaved&&(a=confirm(e.lang.hasUnsavedChanges)),a&&p.removeList(i.id),!1}),t(".arlima-add-section-div",this).click(function(){return i.addSectionDivider(),!1}),i.isImported||(t(".arlima-save-list",this).click(function(){return i.isUnsaved?(p.setFocusedList(i.id),p.saveFocusedList(),!1):!1}),t(".arlima-preview-list",this).click(function(){return p.previewList(i),!1}),t(".arlima-list-version-ddl",this).change(function(a){var r=!0;!l(a)&&i.isUnsaved&&(r=confirm(e.lang.hasUnsavedChanges)),r&&p.reloadList(i,t(this).val())}),t(".arlima-list-version",this).click(function(e){return t(".arlima-list-version-info",this).hide(),t(".arlima-list-version-select",this).show(),e.stopPropagation(),!1}))});var u=new r(i,o,a.is_imported,a.title_element,a.options);return u.fill(a.articles,!1,!1),u.displayVersionInfo(a.version,a.versioninfo,a.versions),u.setupStickyIndexes(),u},r.prototype.setupStickyIndexes=function(){var e=this;this.jQuery.find(".sticky").each(function(){e.addIndexFromLastSectionDivider(t(this))})},r.listsInolvedInTransaction=[],r.copyFromList=!1,r.prototype.applyListBehavior=function(){var i=function(e,i){e.data(t.extend({},i.data()));var a=e.find("ul li");if(a.length>0)for(var r=i.find("ul li"),s=a.length-1;s>=0;s--)a.eq(s).data(t.extend({},r.eq(s).data()))};if(this.isImported)this.jQuery.find("li").draggable({sender:"importedlist",helper:"clone",handle:".handle",connectToSortable:".arlima-list",revert:"invalid",zIndex:40,start:function(e,i){var a=t(e.currentTarget);i.helper.width(a.width())}});else{var a=this,s=this.jQuery.find("ul:first");s.hasClass("ui-sortable")||s.nestedSortable({items:"li",listType:"ul",maxLevels:2,opacity:.6,tabSize:30,tolerance:"pointer",connectWith:[".arlima-list:not(.imported)"],distance:15,placeholder:"arlima-listitem-placeholder",forcePlaceholderSize:!0,toleranceElement:"> div",start:function(e){r.copyFromList=!1,r.listsInolvedInTransaction=[],l(e)&&(r.copyFromList=parseInt(t(this).parent().parent().attr("data-list-id")),-1==t.inArray(r.copyFromList,r.listsInolvedInTransaction)&&r.listsInolvedInTransaction.push(r.copyFromList))},helper:function(e,a){if(l(e)){var r=t(a.clone(!0).insertAfter(a));i(r,a),r.hasClass("edited")&&r.removeClass("edited"),r.effect("highlight",500)}return a.clone()},receive:function(e,s){var n=t(s.item),o=n.hasClass("dragger"),l=n.hasClass("ui-draggable");if(o||l){var d=o?"dragger":"ui-draggable",h=t(this).find("."+d+":first");i(h,n);var m=h.data("article");h.removeClass("dragger"),h.removeClass("ui-draggable"),o&&(t(".arlima-listitem-title",h).html(r.getArticleTitleHTML(m)),h.data("article",m));var u=p.getList(n);(!u||u.isImported)&&r.bindArticleItemEvents(h),u&&u.isImported&&p.triggerEvent("articleImported",n);var f=[];u&&u.isImported&&!t.isEmptyObject(m.children)&&t.each(m.children,function(t,e){e.image_options&&e.image_options.url&&f.push([e.image_options.url,h.find(".listitem").eq(t)])}),u&&u.isImported&&m.image_options.url&&!m.image_options.attach_id?r.uploadExternalImage(m.image_options.url,h,function(){f.length>0&&r.uploadExternalImage(f)}):f.length>0&&r.uploadExternalImage(f),r.copyFromList&&!l||n[0]!=c.$item[0]||c.edit(h,a)}},update:function(e,i){var a=t(i.item),s=a.parent().parent(),n=a.data("article");n.parent=s&&s.hasClass("listitem")?s.prevAll().length:-1,a.data("article",t.extend({},n));var o=parseInt(t(this).parent().parent().attr("data-list-id"));-1==t.inArray(o,r.listsInolvedInTransaction)&&r.listsInolvedInTransaction.push(o),a.effect("highlight",500),r.applyItemPresentation(a,n)},stop:function(i,s){var n=t(s.item),o=n.data("article");if(!e.is_admin&&o.options&&o.options.admin_lock&&o.options.sticky)return t(this).nestedSortable("cancel"),void 0;if(r.copyFromList&&1==r.listsInolvedInTransaction.length){n.data("article",t.extend({},n.data("article")));var l=r.listsInolvedInTransaction[0];p.getList(l).toggleUnsavedState(!0),p.setFocusedList(l)}else r.copyFromList?t.each(r.listsInolvedInTransaction,function(t,e){e!=r.copyFromList&&(p.getList(e).toggleUnsavedState(!0),p.setFocusedList(e))}):t.each(r.listsInolvedInTransaction,function(t,e){p.getList(e).toggleUnsavedState(!0),p.setFocusedList(e)});n.hasClass("sticky")||n.hasClass("section-divider")||t.each(r.listsInolvedInTransaction,function(t,e){var i=p.getList(e);if(!i.isImported){var a=n.index();n.data("article").parent>-1&&(a=n.parent().parent().index()),i.rePositionStickyArticles()}}),n.hasClass("sticky")&&(o.options.sticky_pos=n.prevAll().length,c.$item[0]==n[0]&&t("#arlima-option-sticky-pos").val(o.options.sticky_pos),n.data("article",o),a.addIndexFromLastSectionDivider(n)),n.hasClass("section-divider")&&a.setupStickyIndexes(),t.each(r.listsInolvedInTransaction,function(e,i){var a=p.getList(i);a.jQuery.find(".listitem").each(function(){var e=t(this);e.find("ul li").length>0&&a.setupChildClasses(e)})}),p.triggerEvent("articleDropped",n),r.listsInolvedInTransaction.length=0,c.isEditingArticle()&&c.$item.data("article").id==n.data("article").id}})}},r.uploadExternalImage=function(e,i,a){c._$imgContainer.addClass("ajax-loader-icon");var r=function(t,e){if(e[0]==c.$item[0])c.updateArticleImage({html:t.html,size:"full",attach_id:t.attach_id});else{var i=e.data("article");i.image_options=c.createArlimaArticleImageObject(t.html,"aligncenter","full",t.attach_id,0,""),e.data("article",i),p.getList(e).toggleUnsavedState(!0)}};if(t.isArray(e)){var n=function(){if(0==e.length)c._$imgContainer.removeClass("ajax-loader-icon"),"function"==typeof a&&a();else{var t=e.splice(0,1)[0];d.plupload(t[0],"",function(e){e?r(e,t[1]):s("Unable to upload external image","error"),n()})}};n()}else d.plupload(e,"",function(t){c._$imgContainer.removeClass("ajax-loader-icon"),t?r(t,i):s("Unable to upload external image","error"),"function"==typeof a&&a()})};var h={name:"dark",tip:!0,padding:"1px 3px",fontSize:11,background:"#111",border:{width:2,radius:5,color:"#111"}};return{Backend:d,ArticleEditor:c,Manager:p,List:r,qtipStyle:h}}(jQuery,ArlimaJS,ArlimaTemplateLoader,window);