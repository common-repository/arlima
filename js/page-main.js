/**
 * This file contains everything that happens when the page for
 * the list manager gets loaded
 *
 * @todo Fix all insufficient use of jQuery
 */function arlimaTinyMCEChanged(){Arlima.ArticleEditor.updateArticle()}jQuery(function(i){Arlima.Manager.init("#arlima-container-area"),Arlima.ArticleEditor.init(),ArlimaUploader.init(),Arlima.Manager.loadCustomTemplates(),Arlima.Manager.setupFileIncludes(),ArlimaJS.is_admin&&i.isNumeric(ArlimaJS.is_admin)&&(ArlimaJS.is_admin=parseInt(ArlimaJS.is_admin)),Arlima.Manager.loadSetup(function(){"undefined"!=typeof loadArlimListOnLoad&&Arlima.Manager.addList(loadArlimListOnLoad)}),setTimeout(function(){i("#tinyMCE_ifr").css("height","120px")},800),i("[title].tooltip").qtip({position:{my:"left top",at:"center right"},style:Arlima.qtipStyle}),i("[title].tooltip-left").qtip({position:{corner:{tooltip:"bottomLeft",target:"topLeft"}},style:Arlima.qtipStyle}),i(".fancybox").fancybox({speedIn:300,speedOut:300,titlePosition:"over"});var t=i("#arlima-article-image-options");i("#arlima-article-image-scissors-popup").fancybox({autoResize:1,fitToView:1,margin:new Array(40,0,0,0),speedIn:300,speedOut:300,titlePosition:"over",autoDimensions:!0,afterClose:function(){i("#arlima-article-image-container").removeClass("arlima-fancybox media-item-info").addClass("media-item-info").removeAttr("style"),i("#arlima-article-image img").removeClass("thumbnail"),i("#arlima-article-image-scissors").html("").hide(),Arlima.ArticleEditor.updateArticleImage({updated:Math.round((new Date).getTime()/1e3)}),Arlima.ArticleEditor.removeImageVersions()},beforeLoad:function(){var e=t.data("image_options");Arlima.Backend.loadScissorsHTML(e.attach_id,function(t){t&&i("#arlima-article-image-scissors").html(t).show()}),i("#arlima-article-image-container").addClass("arlima-fancybox media-item-info"),i("#arlima-article-image img").addClass("thumbnail").removeAttr("width").removeAttr("height")}});var e=Arlima.ArticleEditor.PostConnector.$fancyBox,a=e.find(".button"),r=!1;i("#arlima-article-connected-post-change").fancybox({speedIn:300,speedOut:300,titlePosition:!1,autoResize:1,fitToView:1,afterClose:function(){if(r!==!1){var i=void 0,t="";"external"===r?(i=e.find("select").val(),t=e.find("input.url").val()):t=e.find("input.post-connection").val(),Arlima.ArticleEditor.PostConnector.connect(t,i),r=!1}},beforeLoad:function(){var i=Arlima.ArticleEditor.PostConnector,t=Arlima.ArticleEditor.$item.data("article");if(r=!1,e.find(".connection").text(i.getConnectionLabel()),e.find(".invalid-info").remove(),e.find(".connection-containers").hide(),a.filter(".open").css("opacity",1),e.find("input,select").val(""),e.find("option").removeAttr("selected"),!t.post_id){e.find(".url").val(t.options.overriding_url||"");var n=t.options.target;n&&e.find('option[value="'+n+'"]').attr("selected","selected")}}}),a.filter(".open").click(function(){return a.filter(".open").css("opacity",1),this.style.opacity="0.6",e.find(".connection-containers").hide(),e.find("."+this.href.split("#")[1]).show(),!1}),e.find("input,select").bind("change",function(){r=e.find(".external-url").is(":visible")?"external":"post-id";var t=i(this);if(t.hasClass("url")){var a=t.val();0===a.indexOf("#")||""==a||0===a.toLowerCase().indexOf("javascript: ")||a.match(/(^|\s)((https?:\/\/)?[\w-]+(\.[\w-]+)+\.?(:\d+)?(\/\S*)?)/gi)?t.parent().find(".invalid-info").remove():t.after('<em style="color:darkred" class="invalid-info"><br />'+ArlimaJS.lang.invalidURL+"</em>")}}),e.find(".do-search").click(function(){var t=i.trim(e.find('input[type="search"]').val());return Arlima.Backend.queryPosts({search:t},function(t){var a=e.find(".search-result");if(0==t.posts.length)a.html("<p>"+ArlimaJS.lang.nothingFound+"</p>");else{var n="";i.each(t.posts,function(i,t){n+='<p><a href="#" data-post="'+t.post_id+'">'+t.title+"</a></p>"}),a.html(n),a.find("a").click(function(){return r="post-id",e.find(".post-connection").val(i(this).attr("data-post")),i(".fancybox-close").click(),i("#fancybox-close").click(),!1})}}),!1}),i(".sticky-interval-fancybox").fancybox({autoResize:1,fitToView:1,speedIn:300,speedOut:300,titlePosition:!1,afterClose:function(){var t=Arlima.ArticleEditor.$item.data("article"),e=t.options.sticky_interval,a=i("#sticky-interval-fancybox"),r=function(i){var t="*",e=a.find("."+i);return e.filter(":checked").length!=e.length&&(t="",e.filter(":checked").each(function(){t+=","+this.value}),t=""==t?"*":t.substr(1)),t},n=r("day")+":"+r("hour");n!=e&&(t.options.sticky_interval=n,Arlima.ArticleEditor.$item.data("article",t),i("#arlima-interval").val(t.options.sticky_interval),Arlima.ArticleEditor.updateArticle(!0,!1))},beforeLoad:function(){var t=Arlima.ArticleEditor.$item.data("article"),e=i("#sticky-interval-fancybox").find("input");e.removeAttr("checked"),i.each(t.options.sticky_interval.split(":"),function(t,a){if("*"==i.trim(a)){var r=0==t?".day":".hour";e.filter(r).attr("checked","checked")}else i.each(a.split(","),function(i,t){e.filter('[value="'+t+'"]').attr("checked","checked")})})}});for(var n=i("#sticky-hour-container").children().eq(0),l=1;25>l;l++){var o=10>l?"0"+l:l,c=l%8===0?"<br />":"";i('<label><input type="checkbox" class="hour" value="'+o+'" /> '+o+"</label>"+c).insertBefore(n)}var s=!1,d=i("#arlima-edit-article-title-fontsize"),m=i("#arlima-edit-article-title-fontsize-slider").slider({value:18,min:8,max:100,slide:function(i,t){s=!0,d.val(t.value),Arlima.ArticleEditor.updateArticle()}}).mousedown(function(){s=!0});i("#arlima-edit-article-options-streamer-color").colourPicker({ico:"",title:!1}),setInterval(function(){Arlima.Manager.iterateLists(function(i){i.isImported&&!Arlima.ArticleEditor.isEditingList(i.id)&&Arlima.Manager.reloadList(i)})},9e4),i("#file-include-info input").bind("change",function(){0===this.value.indexOf("?")&&(this.value=this.value.substr(1)),this.value=this.value.replace(/ \& /g,"&"),this.value=this.value.replace(/\& /g,"&"),this.value=this.value.replace(/ \&/g,"&"),this.value=this.value.replace(/ \= /g,"="),this.value=this.value.replace(/\= /g,"="),this.value=this.value.replace(/ \=/g,"="),this.value=i.trim(this.value)}),i("#arlima-edit-article-options-template").change(function(){Arlima.ArticleEditor.toggleAvailableFormats(this.value),Arlima.ArticleEditor.toggleEditorFeatures(this.value),Arlima.ArticleEditor.updatePreview(),Arlima.Manager.triggerEvent("templateChange")}),i("#arlima-search-lists").arlimaListSearch("#arlima-lists .arlima-list-link"),i(".arlima-list-link").on("click",function(){Arlima.Manager.addList(i(this).attr("data-alid"))}),i("#arlima-refresh-all-lists").click(function(i){var t=!0;return!i.metaKey&&Arlima.Manager.getUnsavedLists().length>0&&(t=confirm(ArlimaJS.lang.unsaved)),t&&Arlima.Manager.iterateLists(function(i){Arlima.Manager.reloadList(i)}),!1}),i("#arlima-article-image").click(function(t){t.preventDefault();var e=Arlima.ArticleEditor.data("post_id");i.isNumeric(e)?(i("#arlima-article-attachments").html(""),Arlima.Backend.getPostAttachments(e,function(t){var e=i("#arlima-article-attachments");i.each(t,function(t,a){i("<div></div>").addClass("arlima-article-attachment").html(a.thumb).on("click",function(){var t=Arlima.ArticleEditor.createArlimaArticleImageObject(a.large,"center","full",a.attach_id);t.connected=1,Arlima.ArticleEditor.updateArticleImage(t),i("#fancybox-close").trigger("click")}).appendTo(e)})}),i.fancybox({minHeight:200,href:"#arlima-article-attachments"})):alert(ArlimaJS.lang.noImages)}),i("#arlima-toggle-preview").click(function(){return Arlima.ArticleEditor.togglePreview(),!1}),i("#arlima-preview-active-list").click(function(){return Arlima.Manager.previewFocusedList(),!1}),i("#arlima-save-active-list").click(function(){return Arlima.Manager.saveFocusedList(),!1}),i("#arlima-add-list-btn").click(function(){var t=i("#arlima-add-list-select").val();return t&&Arlima.Manager.addList(t),!1}),i(".time-checkbox-toggler").on("click",function(){var t=i(this).parent().parent().find("input[type=checkbox]");return 0==t.filter("*:checked").length?t.attr("checked","checked"):t.removeAttr("checked"),!1}),i("html").click(function(){i(".arlima-list-version-select").hide(),i(".arlima-list-version-info").show(),s=!1}),window.onbeforeunload=function(){return Arlima.Manager.previewWindow&&Arlima.Manager.previewWindow.close(),Arlima.Manager.getUnsavedLists().length>0?ArlimaJS.lang.unsaved:void 0},i("#arlima-save-setup-btn").click(function(){Arlima.Manager.saveSetup()}),i("#arlima-edit-article-form").change(function(t){var e=i(t.target),a=e.attr("name");if("image_align"!=a&&"post_id"!=a&&"arlima-article-image-size"!=e.attr("id")){var r=-1==i.inArray(a,["title","options-pre_title","options-streamer_content","options-hiderelated","url"]);Arlima.ArticleEditor.updateArticle(!0,r)}}).find("input").bind("keyup",function(){i.inArray(this.name,["title","options-pre_title","options-streamer_content","post_id","url"])>-1&&Arlima.ArticleEditor.updateArticle(this,-1==i.inArray(this.name,["post_id","url"]))}),t.find("input").click(function(){Arlima.ArticleEditor.updateArticleImage({updated:Math.round((new Date).getTime()/1e3)})}),t.find("select").change(function(){Arlima.ArticleEditor.updateArticleImage({updated:Math.round((new Date).getTime()/1e3)})}),i("#arlima-article-image-remove").click(function(){i(".hide-if-no-image").hide(),Arlima.ArticleEditor.removeArticleImage()}),i("#arlima-edit-article-options-streamer-image-list img").click(function(){i("[name='options-streamer_image']").val(i(this).attr("alt")),Arlima.ArticleEditor.updateArticle(),i.fancybox.close()}),i('.arlima-button input[type="checkbox"]').on("change",function(){var t=i(this);t.is(":checked")?t.parent().addClass("checked"):t.parent().removeClass("checked")}),i("#arlima-option-sticky").on("change",function(){var t=i(this).is(":checked"),e=Arlima.ArticleEditor.$item.data("article");t?(e.options.sticky_pos=Arlima.ArticleEditor.$item.prevAll().length,i("#arlima-option-sticky-pos").val(e.options.sticky_pos)):e.options&&e.options.sticky_pos&&(i("#arlima-option-sticky-pos").val(""),e.options.sticky_pos=""),Arlima.ArticleEditor.$item.data("article",e)}),i(window).bind("resize",function(){var i=Arlima.Manager.getFocusedList();i&&i.isImported&&Arlima.ArticleEditor.isEditingArticle()&&Arlima.ArticleEditor.toggleEditorBlocker(!0)}),i(".handlediv").click(function(){i(this).parent().find(".inside").slideToggle(200)}),i("#arlima-post-search").submit(function(){return Arlima.Manager.searchWordpressPosts(0),!1});var u=i(document);u.on("click",".arlima-get-posts-paging",function(){return Arlima.Manager.searchWordpressPosts(i(this).attr("alt")),!1});var f=setInterval(function(){if(void 0!==tinyMCE&&(clearInterval(f),tinyMCE.editors&&tinyMCE.editors.length>0)){i(tinyMCE.editors[0].getDoc()).contents().find("body").focus(function(){Arlima.Manager.setFocusedList(Arlima.ArticleEditor.currentlyEditedList)});var t=1;tinyMCE.editors[0].onKeyDown.add(function(i,e){var a=e.keyCode?e.keyCode:e.which;switch(a){case 80:if(e.ctrlKey||e.metaKey)return Arlima.ArticleEditor.togglePreview(),e.preventDefault(),!1;break;case 32:t%3===0?(arlimaTinyMCEChanged(),t=1):t++;break;case 76:if(e.ctrlKey||e.metaKey)return Arlima.Manager.previewFocusedList(),e.preventDefault(),!1}})}},500);i("#arlima-article-image-disconnect").click(function(){var t=i("#arlima-article-image-attach_id").val();if(!i.isNumeric(t))throw new Error("Trying to disconnect image that is not connected");return Arlima.Backend.duplicateImage(t,function(i){if(i){var t={attach_id:i.attach_id,html:i.html,connected:0,updated:Math.round((new Date).getTime()/1e3)};Arlima.ArticleEditor.updateArticleImage(t,!0)}}),!1});var p=function(t){var e=i(t.target),a=e.attr("id");if(a&&0==a.indexOf("scissorsCrop")){var r=i("#arlima-article-image-attach_id").val(),n=function(t,e,a){i("<button></button>").html(t).addClass("button").appendTo("#scissorsCropPane-"+r).bind("click",function(){return i("#scissorsLockBox-"+r).prop("checked",!0),scissorsAspectChange(r),i("#scissorsLockX-"+r).val(e),i("#scissorsLockY-"+r).val(a),scissorsManualAspectChange(r),!1})};n("Widescreen",16,9),n("19:9",19,9),n("Cinema",21,9),n("Square",666,666),e.find('input[type="checkbox"]').each(function(){this.id&&0==this.id.indexOf("scissorsLockBox")&&i(this).prop("checked",!1)}),e.find("div").each(function(){this.id&&0==this.id.indexOf("scissorsReir")&&i("#"+this.id).hide()})}else a&&0===a.indexOf("scissorsWatermark")&&e.find('input[type="checkbox"]').each(function(){if(this.id&&0==this.id.indexOf("scissors_watermark_target")){var t=this.id.split("_");void 0!==t[3]&&(t=t[3].split("-"),i(this).prop("checked",!0),scissorsWatermarkStateChanged(t[t.length-1],t[0]))}})};document.addEventListener("DOMNodeInserted",p),u.bind("keydown",function(t){var e=t.keyCode?t.keyCode:t.which;if((t.ctrlKey||t.metaKey)&&i.inArray(e,[80,83,76])>-1){switch(e){case 80:Arlima.ArticleEditor.togglePreview();break;case 83:Arlima.Manager.saveFocusedList();break;case 76:Arlima.Manager.previewFocusedList()}return!1}if(i.inArray(e,[39,37])>-1&&s&&Arlima.ArticleEditor.isEditingArticle()){var a=parseInt(d.val(),10);return a+=37==e?-1:1,m.slider("value",a),d.val(a),Arlima.ArticleEditor.updateArticle(),!1}})});